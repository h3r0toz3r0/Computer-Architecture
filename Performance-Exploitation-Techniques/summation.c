#include <stdio.h>
#include <stdlib.h>
#include <pthread.h> 
#include <time.h>

/* global variables */
volatile int sum = 0.0; 
pthread_mutex_t sumLock;        /* how we synchronize writes to 'sum' */
int numThreads;                /* how many threads we use */

#define THREAD_NUM 10
#define SIZE 128

void *computeSUM(void *id)
{
    int localSum = 0;
    int threadID = *((int*)id);
    int i;

    int array[SIZE];
    for(i = 0; i < SIZE; i++){
      array[i] = i + 1;
    }
    int partition = SIZE / THREAD_NUM;
    int max = THREAD_NUM - 1;

    for(i = (threadID * partition); i < SIZE; i++){
      if(THREAD_NUM != 0 && (THREAD_NUM & (THREAD_NUM - 1)) != 0){
        if(threadID != max && i < ((threadID * partition) + partition)){
          localSum += array[i];
        }
        if(threadID == max){
          localSum += array[i];
        }
      }
      else{
        if(i < ((threadID * partition) + partition)){
          localSum += array[i];
        }
      }
    }

    pthread_mutex_lock(&sumLock);
    sum += localSum;
    pthread_mutex_unlock(&sumLock); 

    return NULL;
} 

int main(int argc, char *argv[]){
  clock_t start_t, end_t;
  double total_t;
  pthread_t *threads;        /* dynarray of threads */
  void *retval;              /* unused; required for join() */
  int *threadID;             /* dynarray of thread id #s */
  int i;                     /* loop control variable */

  printf("The number of threads is %i \n", THREAD_NUM);

  start_t = clock();

  threads = malloc(THREAD_NUM*sizeof(pthread_t));
  threadID = malloc(THREAD_NUM*sizeof(int));

  pthread_mutex_init(&sumLock, NULL);

  for (i = 0; i < THREAD_NUM; i++) {
    threadID[i] = i;
    pthread_create(&threads[i], NULL, computeSUM,threadID+i);
  }

  for (i = 0; i < THREAD_NUM; i++) {
     pthread_join(threads[i], &retval);
  }

  end_t = clock() - start_t;

  printf("Estimation of sum is %d \n", sum);
  printf("(actual sum value is 8,256)\n");

  total_t = ((double)end_t) / CLOCKS_PER_SEC;
  printf("Total time taken by CPU: %f\n", total_t  );

  return 0;
}
